---
title: "Peso do bebê"
author: "William Peixoto"
date: "knit mais recente: `r format(Sys.Date(), format = '%d de %B %Y')`" 
output: 
  html_document:
    theme: cosmo  # TODO Achar um tema com melhor contraste nos resultados dos blocos
    highlight: zenburn  # espresso  # pygments
#    css: Rmd_001.css
    css: Extra.css
    toc: True
    # number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

cssTODO = 'style="text-decoration:underline; background:green"'
subtitle = function(text) {
  # return(paste('<p style="font-size:x-large">', text, '</p>'))
  return(paste('<h3>', text, '</h3>'))
}
```

<!-- # Análise do peso do bebê -->

Exercício de Métodos Inferenciais Avançados 2/18


```{r Data Load, echo=FALSE}
# bloco de código - item a


NCbirths = read.csv("NCbirths.csv")
nc_births = NCbirths
# str(nc_births)
# summary(nc_births)

# col.sums = colSums(is.na(nc_births))
# col.sums[col.sums>0]  # Verificação programática de quais colunas têm NAs

nc_births<- cbind(nc_births, somaNulos = rowSums(is.na(nc_births)))
NCB_NAs = nc_births[nc_births$somaNulos > 0,]
NCBnoNAs = nc_births[complete.cases(nc_births),]

```

Há `r nrow(NCB_NAs)` observações com alguma informação faltando e `r nrow(NCBnoNAs)` casos completos.

```{r Fatorizar o data frame, echo=FALSE}
# Fatorizar o que der
source("factorize.R")

useEtn = TRUE  # Flag para unificar campos étnicos

nc_births = NCB_noId(nc_births)
nc_births = NCB_factorize(nc_births, useEtn)

#ncb_births_noGainedNA = nc_births[!is.na(nc_births$Gained), ]
# ncb_births_noNAsAtAll = nc_births[ncb_births_noGainedNA$somaNulos == 0, ]
ncb_births_noNAsAtAll = nc_births[nc_births$somaNulos == 0, ]

if (useEtn) {
  COLS_W = c("Plural", "Sex",    "MomAge", "Weeks",  "Marital",
           "Gained", "Smoke", "BirthWeightOz", "Premie", "Etnicidade")
} else {
  COLS_W = c("Plural", "Sex",    "MomAge", "Weeks",  "Marital",
           "RaceMom",  "HispMom", "Gained", "Smoke",
           "BirthWeightOz", "Premie", "MomRace")
}
ncb_weight = nc_births[, COLS_W]
# ncb_weight_noNAs = ncb_births_noGainedNA[, COLS_W]  # ncb_births_noNAsAtAll
ncb_weight_noNAs = ncb_births_noNAsAtAll[, COLS_W]  # 

ncb_weigh_patchedNA = ncb_weight
# ncb_weigh_patchedNA[ncb_weigh_patchedNA$somaNulos >0, "Gained"] = mean(ncb_weigh_patchedNA$Gained, na.rm = T)

ncb_weigh_patchedNA[is.na(ncb_weigh_patchedNA$Gained), "Gained"] = mean(ncb_weigh_patchedNA$Gained, na.rm = T)
ncb_weigh_patchedNA[is.na(ncb_weigh_patchedNA$Smoke), "Smoke"] = "N"

# $Gained[is.na(ncb_weight$Gained)] = mean(ncb_weight$Gained)



# Remover coluna desnecessária
# ncb_births_noGainedNA$somaNulos <- NULL
nc_births$somaNulos <- NULL
```

# Análise descritiva dos dados

## Correlação entre colunas
```{r}
alias(lm(BirthWeightOz ~ . - BirthWeightGm, data = new_ncbirths(NCbirths)))
alias(lm(BirthWeightOz ~ . - BirthWeightGm, data = new_ncbirths(NCbirths, T)))

```

A sobreposição de informações dadas nas colunas étnicas aparece no relatório criado pela função `alias()`. Isso pôde ser corrigido ao se unificar as informações em uma única coluna.

Curiosamente, há combinações inesperadas ali, como mães negras oriundas de Porto Rico e da América do Sul sendo consideradas também hispânicas. Por outro lado, distinguir índios de continentes distintos parece compreensível.

# Modelos lineares  {.tabset .tabset-fade .tabset-pills} 

## Modelo 3: Naïve

Da mesma forma que no modelo 1, vejamos com o que se parece um modelo com "tudo" dentro. Entretanto, como há campos com forte correlação entre si e com a variável dependente, precisamos nos livrar antes de:

- BirthWeightGm
- Low

Além disso, os 40 casos de ganho de peso ausentes precisam ser avaliados para uma tomada de decisão.
```{r}
# ncb_weight_noNAs = complete.cases(ncb_weight)

fit_weight_1 = lm(BirthWeightOz ~ ., data=ncb_weight, na.action = na.omit)
``` 

### Omitindo valores ausentes
```{r Sem NAs}
summary(fit_weight_1)

``` 
### Tomando os valores ausentes como a média
```{r Com NAs remendados}
summary(lm(BirthWeightOz ~ ., data=ncb_weigh_patchedNA, na.action = na.omit))

```

### A mãe filipina

Chama a atenção o coeficiente para  <!-- `RaceMomFilipino` --> `Etnicidadefilipino`, com valor absoluto elevado e com significância de <s>0.055637</s> 0.074320 (0.076736 no modelo que inclui as linhas com valores ausentes), perto do limite escolhido para $\alpha$. Existe exatamente 1 registro de mãe com essa etnia.

```{r Modelo sem a mãe filipina}
if (useEtn) {
  ncb_weight_NF = ncb_weight[ncb_weight$Etnicidade != "filipino",]
} else {
  ncb_weight_NF = ncb_weight[ncb_weight$RaceMom != "Filipino",]
}
fit_weight_1b = lm(BirthWeightOz ~ ., data=ncb_weight_NF, na.action = na.omit)
summary(fit_weight_1b)

```


### Análise de inflação

```{r inflação modelo 3}
library(car)
vif(fit_weight_1)

```

```{r inflação modelo 3b}
vif(fit_weight_1b)
```

As colunas `Weeks` e `Premie` são as que mais inflacionam a variância desse modelo.

## Modelo 4: significativas

<p style="font-size:x-large">Menos é mais de novo</p>
Baseado no contexto e nos valores observados das significâncias dos coeficientes do modelo 3, seleciono um conjunto menor de colunas para comparar...

- Há estudos confirmando que o tabagismo introduz riscos para a gravidez. Um deles é o nascimento de bebês com menor peso.
- Getação múltipla é considerada de alto risco, com maior índice de partos prematuros e consequente peso menor ao nascer.
- O índice de massa corporal da gestante, segundo um estudo realizado pelo Cincinnati Children’s Hospital Medical Center do estado de Ohio, nos Estados Unidos, pode estar ligado a 25% dos nascimentos prematuros.
```{r}
#COLSET_01 = c("Plural", "Sex",    "MomAge", "Weeks", 
#              "Gained", "Smoke",
#              "BirthWeightOz")

fit_weight_2 = lm(BirthWeightOz ~ Plural + Sex + MomAge + Weeks + Gained + Smoke,
                  data = ncb_weight)
summary(fit_weight_2)

fit_weight_2b = lm(BirthWeightOz ~ Plural + Sex + MomAge + Weeks + Gained + Smoke,
                  data = ncb_weight_NF)
summary(fit_weight_2b)

anova(fit_weight_1, fit_weight_2)

anova(fit_weight_1b, fit_weight_2b)
```

## Modelo 5: Etnias

`r subtitle("Dá pra colocar algo de volta?")`

```{r}
if (useEtn) {
  fit_weight_5 = lm(BirthWeightOz ~ Plural + Sex + MomAge + Weeks + Gained + Smoke + Etnicidade, data=ncb_weight)
  anova(fit_weight_1, fit_weight_5)
} else {
  fit_weight_5 = lm(BirthWeightOz ~ Plural + Sex + MomAge + Weeks + Gained + Smoke + RaceMom, data = ncb_weight)
  summary(fit_weight_5)
  
  fit_weight_5b = lm(BirthWeightOz ~ Plural + Sex + MomAge + Weeks + Gained + Smoke + MomRace, data = ncb_weight)
  summary(fit_weight_5b)
  
  fit_weight_5c = lm(BirthWeightOz ~ Plural + Sex + MomAge + Weeks + Gained + Smoke + HispMom, data = ncb_weight)
  summary(fit_weight_5c)
  anova(fit_weight_1, fit_weight_2, fit_weight_5, fit_weight_5b, fit_weight_5c)
}


```

A inclusão dos campos étnicos prejudicou o modelo, pois os erros cresceram ou ficaram confusos (p>0.05).

## Modelo 6: Tempo em separado

TODO: Comparar modelo só com `Weeks` com outro sem.

# Verificação de premissas do modelo linear

<span id="comm_c" class="comando">c.	Verifique as premissas do modelo linear.</span>

- Resíduos
  - Independência: os erros são independentes entre si 
  - Normalidade: 
  - Homocedasticidade (variância constante)
  - Linearidade

## Peso do bebê Modelo 3: Naïve {.tabset .tabset-fade } 

### Com a mãe filipina
```{r}
plot(fit_weight_1)
```

### Sem a  filipina
```{r}
plot(fit_weight_1b)
```


O gráfico de resíduos x valores ajustados apresenta uma forte heterodascidade, com uma grande concentração em volta de 123 Oz.

### Revisão "b"
```{r}
plot(fit_weight_1b)
```


# Propostas

<span class="comando">d. Proposta de modelo</span>

Com base nas análises, proponha um ou mais modelos lineares multivariados. Explique a sua escolha.

```{r}
# bloco de código - item d



```

### Predições

e. <span class="comando">Utilize o(s) modelo(s) proposto(s) para fazer pelo menos uma predição.</span>

```{r}
# bloco de código - item e

weeks = c(10,  # Poucas chances de sobrevivência
          11,
          23,  # 17% de sobrevivência
          25,
          39,  # termo
          39.5,
          40.2,
          44,
          45,
          46,  # risco 
          47)

gained = c(0.5, 11.3, 43.8, 100, 110)

age = c(4, 6, 8, 10, 12, 14,  # Abaixo 
        21.5, 29.3,           # no meio
        44, 45, 46, 60)       # acima

underage_premie = list(Plural="Single", MomAge=10, Sex="M", Weeks=20, Gained=5, Smoke="N")

predict(fit_weight_2, underage_premie)
```


#ENTREGA EM 31/10/2018, ÀS 23h59.


