---
title: "Métodos Inferenciais Avançados"
author: "William Peixoto"
output: 
  html_document:
    toc: True
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

##  Regressão Múltipla

Carregue a base de dados **NCBirths**, disponível em <https://vincentarelbundock.github.io/Rdatasets/datasets.html>. 

Desenvolva os itens a seguir aplicando técnicas gráficas e formais, e apresente resultados, explicações e considerações que julgar necessários.

Utilize o presente documento Markdown (referências em <http://rmarkdown.rstudio.com>, <https://bookdown.org/yihui/rmarkdown/>) para a inserção do código e geração de resultados.

### Estrutura e variáveis

a. Conheça a estrutura dos dados e explore as variáveis quantitativas e qualitativas. 

```{r Data Load}
# bloco de código - item a
library(readr)
# NCbirths <- read_csv("NCbirths.csv", col_types = cols(Marital = col_factor(levels = c("1", 
#     "2")), Plural = col_factor(levels = c("1", 
#     "2", "3")), Sex = col_factor(levels = c("1", 
#     "2")), Smoke = col_factor(levels = c("1", 
#     "2")), X1 = col_skip()))
# View(NCbirths)

NCbirths = read.csv("NCbirths.csv")
str(NCbirths)
summary(NCbirths)
```
#### Erros aparentes

Parece haver uma confusão no registro de raças. Há três campos para isso, e encontrei pelo menos uma inconsistência no aparente registro de mães hispânicas como japonesas:
```{r}
summary(NCbirths[NCbirths$MomRace=="hispanic",])
summary(NCbirths[NCbirths$RaceMom=="Japanese",])
```
Aparentemente, os 164 registros de mães "japonesas" na verdade são hispânicas com a marca incorreta no campo `RaceMom` mas correto em `MomRace`. O que me leva a crer que o correto seria considerar todas como hispânicas é a variedade do campo `HispMom`, que tem apenas 3 marcadas como "Other hispanic" (e que ainda não sei se há alguma chance de serem japonesas), e a ausência de uma marca "Not hispanic".

O campo `Low`, segundo a descrição, chama a atenção para bebês cujo peso ao nascer é inferior a 2500g.

```{r}
summary(NCbirths[NCbirths$Low == "Y", c("BirthWeightOz", "BirthWeightGm")])
summary(NCbirths[NCbirths$Low == "N", c("BirthWeightOz", "BirthWeightGm")])

# summary(NCbirths[NCbirths$BirthWeightGm > 2500, c("Low", "BirthWeightOz", "BirthWeightGm")])
nrow(NCbirths[NCbirths$BirthWeightGm > 2500 & NCbirths$Low=='Y', c("Low", "BirthWeightOz", "BirthWeightGm")])  # Deve ser zero
nrow(NCbirths[NCbirths$BirthWeightGm <= 2500 & NCbirths$Low=='N', c("Low", "BirthWeightOz", "BirthWeightGm")])  # Deve ser zero

```

Foi confirmado que, realmente, os registros marcados como `Low==Y` todos têm peso abaixo de 2500g, e os marcados com `Low==N` todos têm peso acima do informado na documentação. De forma simétrica, nenhum registro inconsistente (isto é, com marca incorreta) foi encontrado, o que caracteriza uma dependência completa.

Por isso, esse campo pode seguramente ser ignorado nas regressões.


#### Valores ausentes
Por inspeção visual, foi possível detectar valores ausentes nas colunas `Weeks`(1), `Smoke`(5) e `Gained`(40). Faremos avaliação de cada caso assim que der.

```{r Check NA}
col.sums = colSums(is.na(NCbirths))
col.sums[col.sums>0]  # Verificação programática de quais colunas têm NAs

NCbirths<- cbind(NCbirths, somaNulos = rowSums(is.na(NCbirths)))
NCB_NAs = NCbirths[NCbirths$somaNulos > 0,]


```

Parece preocupante a grande quantidade de ausências em `Gained`, que corresponde a `r col.sums["Gained"]/nrow(NCbirths)*100`% das linhas. A estratégia ideal depende da alavancagem desses registros.


#### Fatores

Segundo a [documentação](NCbirths.html) do DataSet, várias dessas colunas podem ser convertidas em fatores:

```{r}
# Fatorizar o que der

NCB_noId = function(ncbvar) {
    ncbvar$X <- NULL
    ncbvar$ID <- NULL  
    return(ncbvar)
}


NCB_factorize(ncbvar) {
    ncbvar$Plural <- factor(ncbvar$Plural, levels=c(1,2,3), labels=c('Single', 'Twins', 'Triplets'))
    ncbvar$Sex <- factor(ncbvar$Sex, levels=c(1,2), labels=c("M", "F"))
    ncbvar$Marital <- factor(ncbvar$Marital, labels=c("Married", "Not Married"))
    ncbvar$RaceMom <- factor(ncbvar$RaceMom, levels=c(1,2,3,4,5,7,8),  # There's no Hawaiian in this base
                               labels=c(
                                 "White",
                                 "Black",
                                 "AmericanIndian",
                                 "Chinese",
                                 "Hispanic",  # Era "Japanese", mas foi reconsiderado
                                 # "Hawaiian",  # Não foram encontrados registros
                                 "Filipino",
                                 "OtherAsianOrPacific"
                               ))
    # TODO: Check race assignments more thoroughly

    ncbvar$Smoke <- factor(ncbvar$Smoke, labels = c('N', 'Y'))  # Cuidado com os NAs
    ncbvar$HispMom <- factor(ncbvar$HispMom)
    ncbvar$Premie <- factor(ncbvar$Premie, labels=c("N", "Y"))
    ncbvar$Low <- factor(ncbvar$Low, labels=c("N", "Y"))

    return(ncbvar)
}

NCbirths = NCB_noId(NCbirths)
NCbirths = NCB_factorize(NCbirths)

```

### b.	Faça análises marginais e multivariadas.

Possíveis variáveis dependentes:

- `Plural`: Categórica, pode ser uma logística por Single/Not single
- `Gained`: Contínua
  - Se for possível prever algum valor, ele pode ser usado para preencher os 40 NAs encontrados.
- Tempo de gestação:
    - `Weeks`: Discreta
    - `Premie`: Categórica, depende de `Weeks`
- Peso do bebê:
    - `BirthWeightOz` ou `BirthWeightGm`, numéricas. Em Oz, parece ser apenas inteiro enquanto em g, é float.
        - Se a conversão estiver correta, basta eliminar uma das colunas. Mas estou curioso para ver se o modelo linear vai mostrar alguma diferença inexistente.
  - `Low`: Categórica. Adequada para logística

Prováveis Correlações entre as colunas:

- A mais gritante é a do peso dos bebês, a mesma informação em duas unidades.
- `MomRace`, `HispMom` e `MomRace` (ô povo racista!): Há grande sobreposição entre os conceitos.
    - TODO: Verificar a sobreposição; tentar converter em uma única coluna
- `Weeks` e `Premie`: A segunda depende completamente da primeira
- `BirthWeight{Oz,Gm}` e `Low`: Mesmo caso: A segunda também depende completamente das primeiras
    - TODO: Verificar se todos os `Low` realmente têm peso menor que 2500g

```{r}
# bloco de código - item b

summary(NCbirths$BirthWeightGm/NCbirths$BirthWeightOz)
if (mean(NCbirths$BirthWeightGm/NCbirths$BirthWeightOz)/max(NCbirths$BirthWeightGm/NCbirths$BirthWeightOz) != 1 ) {
  error("Há um erro de conversão entre Oz e g")
} else {
  if (max(NCbirths$BirthWeightGm/NCbirths$BirthWeightOz) == 28.35)  {
    print("Todas as conversões de unidade estão corretas")
  } else {
    print("Embora consistentes, as conversões não estão corretas")
  }
}


```

#### Peso ganho em função das outras variáveis

##### Modelo 1: Naïve
```{r Gained 1}

fit_gained1 = lm(Gained ~ ., data=NCbirths)
summary(fit_gained1)

NCBnoNAs = NCbirths[]

```

Curiosamente, vários campos que eu marquei para exclusão aparecem como NA no sumário, mas não todos: `Low` foi considerado, mas ficou terrivelmente insignificante.

Esse modelo explica apenas 8% do resultado. Será que existem modelos melhores?

#### Modelos melhores

Com base no sumário do modelo naïve, pode-se ver que os campos `Plural` e `BirthWeightOz` foram os únicos significativos.

```{r}
fit_gained2 = lm(Gained ~ Plural + BirthWeightOz, data = NCbirths)
summary(fit_gained2)
```

Como resultado, 

### c.	Verifique as premissas do modelo linear.

```{r fit_gained_ajustado_vs_residuo}
# bloco de código - item c
plot(predict(fit_gained), resid(fit_gained), data=NCbirths,
     main="Valores ajustados cersus resíduos")


```

### d.	Com base nas análises, proponha um ou mais modelos lineares multivariados. Explique a sua escolha.

```{r}
# bloco de código - item d



```

e.	Utilize o(s) modelo(s) proposto(s) para fazer pelo menos uma predição.

```{r}
# bloco de código - item e



```

## ENTREGA EM 31/10/2018, ÀS 23h59.


