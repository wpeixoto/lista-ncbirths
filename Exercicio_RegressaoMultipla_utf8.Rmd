---
title: "Métodos Inferenciais Avançados"
author: "William Peixoto"
output: 
  html_document:
    toc: True
    number_sections: true
    theme: cosmo  # TODO Achar um tema com melhor contraste nos resultados dos blocos
    highlight: zenburn  # espresso  # pygments
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#  Regressão Múltipla

Carregue a base de dados **NCBirths**, disponível em <https://vincentarelbundock.github.io/Rdatasets/datasets.html>. 

Desenvolva os itens a seguir aplicando técnicas gráficas e formais, e apresente resultados, explicações e considerações que julgar necessários.

Utilize o presente documento Markdown (referências em <http://rmarkdown.rstudio.com>, <https://bookdown.org/yihui/rmarkdown/>) para a inserção do código e geração de resultados.

## Estrutura e variáveis

a. Conheça a estrutura dos dados e explore as variáveis quantitativas e qualitativas. 

```{r Data Load}
# bloco de código - item a


NCbirths = read.csv("NCbirths.csv")
nc_births = NCbirths
str(nc_births)
summary(nc_births)
```

Uma inspeção visual já permite identificar NAs nos campos `Weeks`, `Gained` e `Smoke`, mas os campos que a descrição diz serem categóricos foram tratados como numéricos, e seus sumários não fazem sentido.

### Correlações simples
```{r Boxplots, echo=FALSE}
boxplot(nc_births$Gained ~ nc_births$MomAge, main="Peso ganho por faixa etária")
boxplot(nc_births$Gained ~ nc_births$Weeks, main="Peso ganho por duração da gravidez")

# boxplot(nc_births$Gained ~ nc_births$MomRace + nc_births$RaceMom, main='Peso ganho por "Raça"') # Pouco útil sem fatores

```

### Erros aparentes

Parece haver uma confusão no registro de raças. Há três campos para isso, e encontrei pelo menos uma inconsistência no aparente registro de mães hispânicas como japonesas:
```{r Verifica Raças}
for (race in unique(nc_births$MomRace)) { print(paste(race, nrow(nc_births[nc_births$MomRace == race,])))}  # TODO Um Summary não seria melhor?


summary(nc_births[nc_births$MomRace=="hispanic", c("RaceMom", "HispMom")])  # Mostra que `RaceMom` é 5 para todas com `MomRace == hispanic`
JapasSoQueNao = nrow(nc_births[nc_births$RaceMom==5,])  # "Japanese", só que não
print(paste("Registros marcados como mães japonesas: ", JapasSoQueNao))

print("Mães com RaceMom == 5")
summary(nc_births[nc_births$RaceMom==5, c("MomRace", "HispMom")])
```
Aparentemente, os 164 registros de mães "japonesas" na verdade são hispânicas com a marca incorreta no campo `RaceMom` mas correto em `MomRace`. O que me leva a crer que o correto seria considerar todas como hispânicas é a variedade do campo `HispMom`, que tem apenas 3 marcadas como "Other hispanic" (e que ainda não sei se há alguma chance de serem japonesas), e a ausência de uma marca "Not hispanic".

O campo `Low`, segundo a descrição, chama a atenção para bebês cujo peso ao nascer é inferior a 2500g.

```{r Verifica Low}
# summary(nc_births[nc_births$Low == "Y", c("BirthWeightOz", "BirthWeightGm")])
# summary(nc_births[nc_births$Low == "N", c("BirthWeightOz", "BirthWeightGm")])

# summary(nc_births[nc_births$BirthWeightGm > 2500, c("Low", "BirthWeightOz", "BirthWeightGm")])
nrow(nc_births[nc_births$BirthWeightGm > 2500 & nc_births$Low=='Y', c("Low", "BirthWeightOz", "BirthWeightGm")])  # Deve ser zero
nrow(nc_births[nc_births$BirthWeightGm <= 2500 & nc_births$Low=='N', c("Low", "BirthWeightOz", "BirthWeightGm")])  # Deve ser zero

```

Foi confirmado que, realmente, os registros marcados como `Low==Y` todos têm peso abaixo de 2500g, e os marcados com `Low==N` todos têm peso acima do informado na documentação. De forma simétrica, nenhum registro inconsistente (isto é, com marca incorreta) foi encontrado, o que caracteriza uma dependência completa.

Por isso, esse campo pode seguramente ser ignorado nas regressões.


### Valores ausentes
Por inspeção visual, foi possível detectar valores ausentes nas colunas `Weeks`(1), `Smoke`(5) e `Gained`(40). Faremos avaliação de cada caso assim que der.

```{r Check NA}
col.sums = colSums(is.na(nc_births))
col.sums[col.sums>0]  # Verificação programática de quais colunas têm NAs

nc_births<- cbind(nc_births, somaNulos = rowSums(is.na(nc_births)))
NCB_NAs = nc_births[nc_births$somaNulos > 0,]
NCBnoNAs = nc_births[complete.cases(nc_births),]

```

Parece preocupante a grande quantidade de ausências em `Gained`, que corresponde a `r col.sums["Gained"]/nrow(nc_births)*100`% das linhas. A estratégia ideal depende da alavancagem desses registros.


### Fatores

Segundo a [documentação](nc_births.html) do DataSet, várias dessas colunas podem ser convertidas em fatores:

```{r Fatorizar o data frame}
# Fatorizar o que der

NCB_noId = function(ncbvar) {
    ncbvar$X <- NULL
    ncbvar$ID <- NULL  
    return(ncbvar)
}


NCB_factorize = function(ncbvar) {
    ncbvar$Plural <- factor(ncbvar$Plural, levels=c(1,2,3), labels=c('Single', 'Twins', 'Triplets'))
    ncbvar$Sex <- factor(ncbvar$Sex, levels=c(1,2), labels=c("M", "F"))
    ncbvar$Marital <- factor(ncbvar$Marital, labels=c("Married", "Not Married"))
    ncbvar$RaceMom <- factor(ncbvar$RaceMom, levels=c(1,2,3,4,5,7,8),  # There's no Hawaiian in this base
                               labels=c(
                                 "White",
                                 "Black",
                                 "AmericanIndian",
                                 "Chinese",
                                 "Hispanic",  # Era "Japanese", mas foi reconsiderado
                                 # "Hawaiian",  # Não foram encontrados registros
                                 "Filipino",
                                 "OtherAsianOrPacific"
                               ))
    # TODO: Check race assignments more thoroughly

    ncbvar$Smoke <- factor(ncbvar$Smoke, labels = c('N', 'Y'))  # Cuidado com os NAs
    ncbvar$HispMom <- factor(ncbvar$HispMom)
    ncbvar$Premie <- factor(ncbvar$Premie, labels=c("N", "Y"))
    ncbvar$Low <- factor(ncbvar$Low, labels=c("N", "Y"))

    return(ncbvar)
}

nc_births = NCB_noId(nc_births)
nc_births = NCB_factorize(nc_births)

ncb_births_noGainedNA = nc_births[!is.na(nc_births$Gained), ]
ncb_births_noGainedNA = ncb_births_noGainedNA[ncb_births_noGainedNA$somaNulos == 0, ]

# Remover coluna desnecessária
ncb_births_noGainedNA$somaNulos <- NULL
nc_births$somaNulos <- NULL
```

```{r Mais análises}

# boxplot(nc_births$Gained ~ nc_births$MomRace + nc_births$RaceMom, main='Peso ganho por "Raça"') # Pouco útil sem fatores
```

## b.	Faça análises marginais e multivariadas.

### Possíveis variáveis dependentes

Não foi especificado um problema para ser estudado. Vejamos como cada campo poderia ser interpretado se fosse a variável dependente. Há dois grupos: Características da mãe e as da gestação e bebê:

#### Maternas

- `MomAge`: Embora se apresente como numérica discreta, pode ser considerada contínua.
- `Marital`: Categórica com apenas dois valores (Casada ou não)
- Dados "raciais": `MomRace`, `RaceMom` e `HispMom`, todos categóricos
- `Smoke`, categórico
- `Gained`, apesar de ser o peso ganho pela mãe, foi considerado parte da gestação e comentado na seção seguinte

#### Gestação e bebê

- `Plural`: Categórica, pode ser uma logística por Single/Not single
- `Sex`: Categórica, também pode ser uma logística por Male/Female
- `Gained`: Contínua
  - Se for possível prever algum valor, ele pode ser usado para preencher os 40 NAs encontrados.
- Tempo de gestação:
    - `Weeks`: Numérica discreta
    - `Premie`: Categórica, depende de `Weeks`
- Peso do bebê:
    - `BirthWeightOz` ou `BirthWeightGm`, numéricas. Em Oz, parece ser apenas inteiro enquanto em g, é float.
        - Se a conversão estiver correta, basta eliminar uma das colunas. <s>Mas estou curioso para ver se o modelo linear vai mostrar alguma diferença inexistente.</s>
        - A documentação não diz como interpretar esses valores no caso de gravidez múltipla (`Plural`!= "Single")
  - `Low`: Categórica. Adequada para logística. Depende integralmente do peso do bebê.

### Prováveis Correlações entre as colunas

- A mais gritante é a do peso dos bebês, a mesma informação em duas unidades.
- `MomRace`, `HispMom` e `MomRace` (ô povo racista!): Há grande sobreposição entre os conceitos.
    - TODO: <s>Verificar a sobreposição</s>; tentar converter em uma única coluna
- `Weeks` e `Premie`: A segunda depende completamente da primeira
- `BirthWeight{Oz,Gm}` e `Low`: Mesmo caso: A segunda também depende completamente das primeiras
    - TODO: <s>Verificar se todos os `Low` realmente têm peso menor que 2500g</s>

### Escolhas disponíveis

|   | Numéricas   | Categóricas  |   |   |
|---|---|---|---|---|
|   |   |   |   |   |
|   |   |   |   |   |
|   |   |   |   |   |

```{r}
# bloco de código - item b

summary(nc_births$BirthWeightGm/nc_births$BirthWeightOz)
if (mean(nc_births$BirthWeightGm/nc_births$BirthWeightOz)/max(nc_births$BirthWeightGm/nc_births$BirthWeightOz) != 1 ) {
  error("Há um erro de conversão entre Oz e g")
} else {
  if (max(nc_births$BirthWeightGm/nc_births$BirthWeightOz) == 28.35)  {
    print("Todas as conversões de unidade estão corretas")
  } else {
    print("Embora consistentes, as conversões não estão corretas")
  }
}


```

### Peso ganho em função das outras variáveis

#### Modelo 1: Naïve
```{r Gained expl}
 boxplot(nc_births$Gained)
df1 = transform(nc_births, group=cut(MomAge, breaks = c(-Inf, 18, 24, 30, 35, 40, +Inf), labels = c('<19', '19-24', '25-29', '30-35', '36-40', '>40')))
boxplot(df1$Gained ~ df1$group, main="Ganho de peso por faixa etária", sub="Há pouca variação aparente")

hist(nc_births$Gained, density = 10, breaks = 30)
sw_gained = shapiro.test(nc_births$Gained)

gained_mean = mean(nc_births$Gained, na.rm = T)

```

A distribuição das frequências de pesos ganhos parece ser normal, com média `r gained_mean` e desvio padrão `r sd(nc_births$Gained, na.rm=T)` (apenas os valores presentes. 40 estão faltando), o resultado de um teste Shapiro-Wil é `r sw_gained$statistic` com $p < 5\%$ (`r sw_gained$p.value`).

```{r Gained 1}
fit_gained1 = lm(Gained ~ ., data=ncb_births_noGainedNA)
summary(fit_gained1)

```
Curiosamente, vários campos que eu marquei para exclusão aparecem como NA no sumário, mas não todos: `Low` foi considerado, mas ficou terrivelmente insignificante.

Esse modelo explica apenas 8% do resultado. Será que existem modelos melhores?
```{r Gained 2}

# pairs(Gained ~ ., data=nc_births)
pairs(Gained ~ Plural + MomAge + Weeks + BirthWeightOz, 
      data=nc_births,
      main = "Correlações entre os campos mais significativos"
      )

# fit_gained1_noNAs = lm(Gained ~ ., data=nc_births, na.action = na.omit) 
# summary(fit_gained1_noNAs)

# NCBnoNAs = nc_births[]

```

Não parece haver correlação nenhuma entre esses campos! O único padrão relevante é a já conhecida relação entre a idade gestacional do nascituro e o peso ao nascer: quanto mais próximo do termo (40 semanas), mais pesado; depois do termo, nem tanto.

### Modelo 2: Menos é mais

Com base no sumário do modelo naïve, pode-se ver que os campos `Plural` e `BirthWeightOz` foram os únicos significativos.

```{r}
fit_gained2 = lm(Gained ~ Plural + BirthWeightOz, data = ncb_births_noGainedNA)
summary(fit_gained2)

anova(fit_gained1, fit_gained2)

```

Como resultado, todos os coeficientes são altamente significativos, e a análise de variância informa uma queda de mais de 8000 pontos na soma dos quadrados dos resíduos. Entretanto, o poder de explicação caiu para 6,34%. 


### Modelo 3: Peso do bebê

s
```{r}

```


## c.	Verifique as premissas do modelo linear.

```{r fit_gained_ajustado_vs_residuo}
# bloco de código - item c
plot(predict(fit_gained1), resid(fit_gained1),   # data=nc_births,
     main="Valores ajustados versus resíduos para modelo Naïve")

plot(predict(fit_gained2), resid(fit_gained2),   # data=nc_births,
     main="Valores ajustados versus resíduos para modelo 2 (aprimorado)")


```

## d.	Proposta de modelo

Com base nas análises, proponha um ou mais modelos lineares multivariados. Explique a sua escolha.

```{r}
# bloco de código - item d



```

e.	Utilize o(s) modelo(s) proposto(s) para fazer pelo menos uma predição.

```{r}
# bloco de código - item e



```

# Suspeitas

Até agora, parece não haver evidências suficientes para compor um modelo linear do peso ganho em função de algumas das outras variáveis. O máximo possível de explicação é de 8% com todos os campos, e vários deles geram coeficientes sem significância estatística ($p>5\%$).

Quando passei a considerar o peso do bebê ao nascer (BirthWeightOz) como variável dependente, obtive modelos com maior poder de predição ($ {R_{ajust}}^2 > 40\%$)

## ENTREGA EM 31/10/2018, ÀS 23h59.


